$(function(){
	MU.init();
});
var MU = {
	init: function(){
		$("body").on('focus blur','input[type=text],input[type=password]',function(e){//文本框得失光标事件
			if($(this).attr('data-flag')){return false;}
			if(e.type=='focusin'){
				var str = $.trim($(this).val());
				if(str==this.defaultValue){
					$(this).val('');
				}
				$(this).addClass('focus');
				$(this).parent().next('.errorTxt').hide();
			}else{
				var str = $.trim($(this).val());
				if(str==''){
					$(this).val(this.defaultValue);
				}
				$(this).removeClass('focus');
				
			}
		});
		$("#userChoice li.item").on({//头部用户信息下拉菜单
			mouseenter: function(){
				var w = $(this).outerWidth();
				w = w<=120 ? 120 : w;
				$(this).find('div.user-info').css({'width':w,'left':-1}).show();
				$("#userChoice li.item:last").find('div.user-info').css({'right':-1,"left":"auto"})
			},
			mouseleave: function(){
				$(this).find('div.user-info').hide();
			}
		});
	},
	msgTips: function(status,txt,timeout,callback){
		this.removeTips();
		var flag = status.match('loading')=='loading';
		var zindex = parseInt( new Date().getTime()/1000 );
		var html = '<div class="msgbox_layer_wrap" id="msgTips" style="z-index:'+zindex+'"><span class="msgbox_layer"><span class="icon_clear"></span><span class="icon '+status+'"></span>'+txt+'<span class="icon_end"></span></span></div>';
		$('body').append(html);
		if (flag) {
			$("#msgTips .loading").removeClass('icon');
			if($("div#filter").length<=0){
				$("body").append('<div id="loadingBg"></div>');
				$("#loadingBg").css({
			    	"height": $(document).height()
			    });
			}
		}else{
			$("#msgTips .icon_clear").remove();
			setTimeout(this.removeTips,timeout||1500);
			if(callback){
				var lon = parseInt(timeout) + 400;
				setTimeout(callback,lon);
			}
		};
	},
	removeTips: function(){
		$("#msgTips,#loadingBg").remove();
	},
	conFirm: function(title,msg,ConfirmFun){
		var html='<div class="dialog">'+msg+'</div><div class="btn"><a id="ConfirmFun" href="javascript:;" class="save_btn"><em>确&nbsp;定</em></a><a href="javascript:void(0)" class="clear_btn" onclick="MU.close(this)"><em>取&nbsp;消</em></a></div>';
		this.alert(html,500,title);
		var that = this;
		if(ConfirmFun){
			$("#ConfirmFun").on('click',function(){
				ConfirmFun();
				that.close();
			})
		}
	},
	getCookie: function(name){//取cookie
        if(navigator.cookieEnabled){
            var arr = document.cookie.match(new RegExp("(^| )" + name + "=([^;]*)(;|$)"));
            if(arr != null) return decodeURIComponent(arr[2]);
        }
    },
    setCookie: function(name, value, day){//写cookie
        var exp  = new Date();
        exp.setTime(exp.getTime() + day * 24 * 60 * 60 * 1000);
        if(navigator.cookieEnabled){
            document.cookie = name + "=" + decodeURIComponent(value) + ";expires=" + exp.toGMTString();
        }
    },
    request: function(str){//获取URL参数
		var href = window.location.href;
		var p = str + '=';
		var array = href.split(p);
		if( array.length>1 ){
			var b = array[1].split('&').length;
			return b>1 ? array[1].split('&')[0] : array[1];
		}else{
			return undefined;
		}
	},
	isNum: function(str){//是否正整数
		var reg = /^[1-9]+[0-9]*]*$/;
		return reg.test(str);
	},
	isUrl: function(str){
		var reg = /^((https|http|ftp|rtsp|mms)?:\/\/)?(([0-9a-z_!~*'().&=+$%-]+: )?[0-9a-z_!~*'().&=+$%-]+@)?(([0-9]{1,3}\.){3}[0-9]{1,3}|([0-9a-z_!~*'()-]+\.)*([0-9a-z][0-9a-z-]{0,61})?[0-9a-z]\.[a-z]{2,6})(:[0-9]{1,})?((\/?)|(\/[0-9a-z_!~*'().;?:@&=+$,%#-]+)+\/?)$/i;
		return reg.test(str);
	},
	isPhone: function(str){//验证手机
		//var reg = /^0?(13[0-9]|15[012356789]|18[02356789]|14[57])[0-9]{8}$/
		var reg = /^(1(([35][0-9])|(47)|(45)|[7][0678]|[8][0123456789]))\d{8}$/
		return reg.test(str);
	},
	isEmail: function(str){//验证E-mail
		var apos = str.indexOf("@");
		var dotpos = str.lastIndexOf(".");
		return !(apos<1||dotpos-apos<2);
	},
	delay: function(fn,timeout){//延时（暂停）函数
		var dfd = $.Deferred();
		setTimeout(function() {
			dfd.resolve(fn());
		}, timeout || 0);
		return dfd.promise();
	},
	alert: function(msg,w,title,ConfirmFun,isClose){
		var _this = this;
		var len = $("div[name=wh_alert]").length + 1;
		var html = '<div class="alert" style="width:'+w+'px" id="wh_alert_'+len+'" name="wh_alert">';
		if(title != ''){
			html = html + '<div class="title"><a href="javascript:;" onclick="MU.close(this)"></a>'+title+'</div>'+msg;
		}else{
			html = html + msg;
		}
		if(ConfirmFun){
			html = html + '<div class="btn"><a href="javascript:;" class="save_btn"><em>确&nbsp;定</em></a><a href="javascript:void(0)" class="clear_btn" onclick="MU.close(this)"><em>取&nbsp;消</em></a></div></div>';
			$("body").prepend(html);
			$('#wh_alert_'+len).find('.save_btn').on('click',function(){
				ConfirmFun();
				if(isClose==undefined||isClose){
					_this.close();
				}
			})
		}else{
			html = html + '</div>';
			$("body").prepend(html);	
		}
 		this.mask();
		this.center($('#wh_alert_'+len));
		if(title != ''){this.drag('wh_alert_'+len);}
	},
	show: function(obj){
		var _this = this;
		$(window).scroll(function(){_this.scenter(obj);});
		$(window).resize(function(){_this.scenter(obj);});
	},
	scenter: function(obj){
		var windowWidth = document.documentElement.clientWidth;   
		var windowHeight = document.documentElement.clientHeight;   
		var popupHeight = $(obj).height();   
		var popupWidth = $(obj).width();    
		$(obj).css({   
			"top": (windowHeight-popupHeight)/2+$(document).scrollTop(),   
			"left": (windowWidth-popupWidth)/2   
		});  
	},
	center: function(obj,flag){
		var _this = this;
		var windowWidth = document.documentElement.clientWidth;
		var windowHeight = document.documentElement.clientHeight;   
		var popupHeight = $(obj).height();   
		var popupWidth = $(obj).width();
		//var top = (windowHeight-popupHeight)/2+$(document).scrollTop() > 0 ? (windowHeight-popupHeight)/2+$(document).scrollTop() : 46;
		var top = ($(window).height() - popupHeight) / 2;
		var index = parseInt( new Date().getTime()/1000 );
		$(obj).css({   
			"opacity": 0,
			"top": top-40,   
			"left": (windowWidth-popupWidth)/2,
			"z-index":index
		}); 
		$(obj).animate({"top":'+='+'40px',"opacity":"1"},400,function(){});
	},
	close: function(obj){
		var obj = obj || $(".alert:first").find("div.title").find('a');
		$(obj).parents("div[name=wh_alert]").animate({"top":'-='+'60px',"opacity":"0"},400,function(){
			$(obj).parents("div[name=wh_alert]").remove();
			if($("div.alert").length<=0)
			$("#filter").animate({"opacity":"0"},400,function(){$("#filter").remove();});														
		})
	},
	loading: function(msg){
		$("body").prepend('<div id="msg_loading" class="msgbox"><em></em><span class="loading"></span><span class="msg_right"></span></div>');
		$("#msg_loading .loading").text(msg);
		this.center($("#msg_loading"));
		this.mask();
	},
	removeLoad: function(){
		$("#msg_loading").remove();
		this.delMask();
	},
	mask: function(){
		if($("#filter").length<=0){
			var mybg="<div id='filter'></div>";
			var h = $("body").height() > document.documentElement.clientHeight ? $("body").height() : document.documentElement.clientHeight;
			$("body").append(mybg);
			$("div#filter").height(h);
			$("#filter").animate({"opacity":"0.75"},400);	
		}
	},
	delMask: function(){
		$("#filter").remove();
	},
	drag: function(dragObj){
 		var drag = typeof dragObj === 'string' ? document.getElementById(dragObj) : dragObj;
		var dTitle = drag.getElementsByTagName('div')[0];
		var disX = disY = 0;
		var isDrag = false;
		//drag.style.position = 'absolute';
		dTitle.style.cursor = 'move';
		dTitle.onmousedown = function(evt){
			drag.style.zIndex = parseInt( new Date().getTime()/1000 );
			evt = evt || window.event;
			isDrag = true;

			disX = evt.clientX - drag.offsetLeft;
			disY = evt.clientY - drag.offsetTop;

			this.setCapture && this.setCapture();

			return false;
		}

		dTitle.onmousemove = function(evt){
			evt = evt || window.event;
			if(!isDrag) return false;

			drag.style.margin = 0;
			drag.style.left = evt.clientX - disX + 'px';
			drag.style.top = evt.clientY - disY + 'px';

			return false;
		}

		dTitle.onmouseup = dTitle.onblur = dTitle.onlosecapture = function(){
			isDrag = false;
			dTitle.releaseCapture && dTitle.releaseCapture();
		}
	},
	between: function(m,b){
		return Math.round(Math.random() * (b-m)) + m;
	}
};
(function($){
	$.fn.localList = function(options){//列出用户最近的搜索记录
		var opts = $.extend({}, $.fn.localList.defults, options);
		
		if(options.arr==undefined){return;}
		
		var $this = $(this),
			$arr  = options.arr.split(','),
			list = '<ul class="local-list"></ul>';
			if($arr.length<=0){return;}
			$this.nextAll().remove().end().after(list);
			 
		var listUl = $this.siblings('ul');
		
		$this.click(function(event){
			var width = $this.attr('data-flag') ? $this.width() : $this.outerWidth()-2;
			var left  = $this.attr('data-flag') ? ($this.outerWidth()-$this.width())/2 : 0;
			listUl.show().css({'width':width,"top":$this.outerHeight()-1,"left":left});
			event.stopPropagation();
		});
		
		for(var i=0;i<$arr.length;i++){
			listUl.append('<li title="'+$arr[i]+'">'+$arr[i]+'</li>');
		};
		
		listUl.children('li').on('click',function(event){
			var txt = $(this).text();
			$(this).parent('ul').siblings('input').val(txt);
			$(this).parent('ul').siblings('input').focus();
			//event.stopPropagation();
		});
		
		$(document).click(function(){
			listUl.hide();
		});
	}
})(jQuery);